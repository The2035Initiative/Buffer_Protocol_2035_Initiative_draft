---
title: "Buffer_Protocol_Rough_Draft"
author: "Sofia Ingersoll"
format: html
editor: visual
---

*Rough Draft pls no judging yet*

# Protocol for Creating Buffer Zones & Selecting Random Addresses in Buffer Regions

The following code describes a step-by-step process for creating a map containing buffer zones around points of interest. In this documentation, the data utilized is the [US Wind Data](https://dataverse.harvard.edu/file.xhtml?fileId=7339850&version=1.0), this data is associated with the "Replication Data for: Prevalence and predictors of wind energy opposition in North America", <https://doi.org/10.7910/DVN/LE2V0R>, Harvard Dataverse, V1, 2023. The collaborators on that project include: Stokes, Leah; Franzblau, Emma; Lovering, Jessica R.; Miljanich, Chris.

\~ include more about what the data is about and the outcomes of making visualization \~

Analysis of these areas will provide insight into local resistance and spatially distorted signalling in relation to wind power infrastructure and climate policy.

### Loading Libraries

The following libraries were selected based on their functionality and ability to optimize our data for mapping.

```{r, message = FALSE}
# Loading Libraries
library(tidyverse)      
library(sf)               
library(raster)
library(tmap)
library(terra)
library(stars)
library(smoothr)         
library(maptiles)
library(devtools)
library(ggspatial)
library(sp)
library(RColorBrewer)
```

### Read in the Data

To simplify the following step, it is important to organize your folders in a way that makes sense for your workflow. In many cases, the data sets we work with are typically too large to be uploaded to GitHub. As a result, a common practice is storing your data in a folder, directly outside of your repository in a folder labeled "data".

The code chunk below for `read.csv` demonstrates how to exit your current location using `..` and enter the desired folder location using `/`. It is important that your file path does not contain any spaces and is directly reflective of the file path for the data you wish to read in.

#### U.S. Wind Data

```{r}
# reading in & storing data
wind_data <- read.csv("../data/wind_data/wind_data_usa.csv")  
```

##### Confirm the Data Loaded Properly

Using gg`plot()`, we can see that the geometries stored by this data set correlate to the locations of wind infrastructure plants throughout the United States. In order to visualize these locations with respect to state and county jurisdictions, we'll need to utilize another data set to create a base layer for our map. Here, we'll use the `ggspatial` function `annotation_map_tile`.

```{r}
head(wind_data)                  # displays the first 6 rows of the data
                                 # along with all of the columns 
```

### **Converting lat/long into Raster Data (i.e. sticky geometries)**

Below we will use the package `sf` to convert the lat/long data into a raster geometry column. In this single line, we will also be assigning the CRS EPSG:4326 to the sf data frame. The CRS was selected because it provides a relatively proportionate display of the United States. We are open to suggestions regarding our CRS if a different project better fits our data.

```{r}
wind_sf <- wind_data %>%             # calls desired dataset
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) 
                                     # creates geometry column with desired crs 
```

#### Check-point

Let's stop and see if our outputs are what we expect.

Were the lat/long columns correctly converted into a geometry column? `setdiff()` is a way to quickly determine the differences between two data sets.

```{r}
setdiff(colnames(wind_data), colnames(wind_sf))
setdiff(colnames(wind_sf), colnames(wind_data))
```

If we plot our sf object, is it what we expect?

```{r}
# First visual of the U.S. wind data provided by the geometry points
wind_plants <- ggplot(wind_sf) +
  annotation_map_tile(type = "osm") +
  geom_sf(col = 'darkgreen',
          alpha = 0.5,
          size = 3) 

wind_plants
```

```{r}
roscoe_wind_farm <- wind_sf %>% 
  filter(plant_name %in% "roscoe wind farm llc") %>% 
  st_sf() %>% 
  st_transform(4326) %>% 
  st_make_valid()

extent(roscoe_wind_farm)
```

```{r}
# visualize roscoe wind farm llc in sweetwater, tx 
ggplot(roscoe_wind_farm) +
  annotation_map_tile(type = "osm") +
  geom_sf(col = 'darkgreen',
          alpha = 0.5,
          size = 3) 
```

### AOI Data

#### Nolan County, TX

```{r include=TRUE, eval=FALSE, warning=FALSE, error=FALSE}
tx <- st_read("../data/wind_data/tl_2023_48_tabblock20/tl_2023_48_tabblock20.shp",
                      quiet = TRUE)

# reads in raster data using the sf package st_read function
# the quiet T/F input refers to information output after importing data

tx <- st_transform(tx, "EPSG:4326")

#plot(tx$geometry)
```

## Wrangling & Subsetting

When crafting a bounding box, we need to remember our goal:

-   Geo-locate neighborhoods within a 3km radius of a power plant for surveying.

Note: for every 0.01 change in coordinate decimal degrees equates to 1.11 km in distance.

The extent of our wind plant of interest is roughly (100.67, 32.47). Therefore, we expect our buffer extent to be within ± 0.03 of the extent. To graph a wider perspective, we will make our bounding box 0.06 beyond the wind plant extent.

```{r}
# bounding box of sweetwater tx, created using GeoJSON
bbox <- st_polygon(
  list(
    rbind(
      c(-100.83,
        32.53),
      c(-100.83,
        32.41),
      c(-100.51,
        32.41),
      c(-100.51,
        32.53),
      c(-100.83,
        32.53)
    )
  )
)

# making bounding box an sf object for cropping later
bbox <- bbox %>% 
  st_sfc() %>% 
  st_set_crs(4326) %>%  
  st_make_valid() 

# Crop the tx shapefile to only sweetwater bbox bounds. Some crs wrangling & checking needed before we can crop & plot.
st_crs(tx) == st_crs(bbox)
```

```{r}
# Crop tx shapefile to our bounding box extent
nolan_county <- st_crop(tx, bbox) %>% 
  st_sf() %>% 
  st_transform(4326) %>% 
  st_make_valid()

# check it was properly cropped
ggplot(nolan_county) +
  geom_sf(aes(color = POP20)) 
```

want:

-   a map of Nolan County, TX

-   the name of roscoe wind farm llc wind plant as a point with a 3km buffer donut around it

-   ability to randomly select addresses within the buffer

-   bonus: filter for specific groups of interest

```{r}
ggplot() +
  geom_sf(data = nolan_county$geometry) +
  geom_sf(data = roscoe_wind_farm$geometry, 
          color = "hotpink",
          size = 3)
```

## Buffers

Buffers create polygons representing a set distance from a feature.

The buffer zone dimensions were selected to correlate with the research presented in "Replication Data for: Prevalence and predictors of wind energy opposition in North America".

**Below is psuedocode for now until the cleaning is configured right**

```{r}
roscoe_wind_farm_buffer <- st_buffer(roscoe_wind_farm, dist = 3000) 
```

------------------------------------------------------------------------

### Visualization for Extracting Geo-locations

Notes to improve map:

Better scalebar, compass, graticules - move outside of map. More informative binning that applies to the buffer region. (Is there a way to automate this process?) Move legend to the right. Include the name of the power plant. Include the block or tract ids for the regions within the buffer (maybe subset nolan_county from buffer object). Better colors

```{r}
tm_shape(nolan_county) +
  tm_polygons('POP20',
              palette = 'Purples') +
tm_shape(roscoe_wind_farm_buffer) +
  tm_polygons(alpha = 0.3) +
  tm_shape(roscoe_wind_farm) +
  tm_bubbles(fill = 'tan',
          title = 'Roscoe Wind Farm LLC') +
  tm_scalebar(position = c('left', 'bottom')) +
  tm_graticules(alpha = 0.05) +
  tm_title('Buffer AOI Within 3 km of Roscoe Wind Farm LLC: Nolan County, TX')
  
  #tm_compass(type = 'rose',
   #          lw = 0,
    #         size = 2)
```

```{r}
# Plot median income of Houston census tracts as continuous variable and whether census tract was impacted as discrete variable
ggplot() +
  geom_sf(data = nolan_county, aes(fill = POP20), palette = "Purples") +
  geom_sf(data = roscoe_wind_farm_buffer, fill = "transparent") +
  scale_color_discrete(name = "") +
  labs(title = "Buffer AOI Within 3 km of Roscoe Wind Farm LLC: Nolan County, TX") +
  annotation_scale(location = "br", width_hint = 0.2) +
  annotation_north_arrow(location = "br", which_north = "true", pad_x = unit(0.1, "npc"), pad_y = unit(0.1, "npc"))
```

### Geo-locating Neighborhoods to Survey

want:

-   extract tract id / block id / addresses from buffer region

```{r}

```

### Function to Automate our Process

want:

-   one function that contains all the necessary steps to configure the same outputs above, but for new wind power plants.

We would need a dataset for the entire country. At this point in time, we are limited to the state of Texas.

```{r}

```
